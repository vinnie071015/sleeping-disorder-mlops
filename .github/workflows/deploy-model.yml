name: Build and Deploy to SageMaker

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  ECR_REPOSITORY: sleep-predictor
  SAGEMAKER_ROLE: arn:aws:iam::137568342316:role/SageMakerExecutionRole
  # ç¡¬ç¼–ç çš„æ¨¡å‹æ•°æ®è·¯å¾„ (ä»…ä¾›æµ‹è¯•)
  MODEL_DATA_URL: s3://sleep-disorder-mlops-bucket/sagemaker-tuning-output/svm-tuning-251203-2103-002-c8ccdacc/output/model.tar.gz

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        # ä½¿ç”¨ git commit sha ä½œä¸º tagï¼Œä¿è¯å”¯ä¸€æ€§å’Œå¯è¿½æº¯æ€§
        IMAGE_TAG: ${{ github.sha }} 
      run: |
        echo "Building docker image..."
        # ä¼˜åŒ–ç‚¹ï¼š
        # 1. -f docker/Dockerfile : æŒ‡å®šæ–‡ä»¶ä½ç½®
        # 2. --platform linux/amd64 : ç¡®ä¿å…¼å®¹ SageMaker è¿è¡Œç¯å¢ƒ
        # 3. . : ä¿æŒ Context ä¸ºé¡¹ç›®æ ¹ç›®å½•
        docker build --platform linux/amd64 -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f docker/Dockerfile .
        
        echo "Pushing image to ECR..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        
        # å°†æ„å»ºå¥½çš„å®Œæ•´é•œåƒåœ°å€å†™å…¥ç¯å¢ƒå˜é‡ï¼Œä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_ENV

    - name: Create SageMaker Model (Test with Public Image)
      run: |
        # åŠ¨æ€ç”Ÿæˆå”¯ä¸€çš„æ¨¡å‹åç§°
        TIMESTAMP=$(date +%Y%m%d-%H%M)
        SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
        UNIQUE_MODEL_NAME="test-public-image-${TIMESTAMP}-${SHORT_SHA}"
        
        # ğŸš¨ æ³¨æ„ï¼šè¿™é‡Œç¡¬ç¼–ç äº†å…¬å…±é•œåƒ URI è¿›è¡Œæµ‹è¯•
        TEST_IMAGE_URI="public.ecr.aws/lts/pytorch/pytorch:1.13.1-cpu-py39"

        echo "Creating SageMaker Model with Public Image: $TEST_IMAGE_URI"
        
        aws sagemaker create-model \
          --model-name $UNIQUE_MODEL_NAME \
          --execution-role-arn ${{ env.SAGEMAKER_ROLE }} \
          --primary-container Image=$TEST_IMAGE_URI,ModelDataUrl=${{ env.MODEL_DATA_URL }} \
          --region ${{ secrets.AWS_REGION }}
          
        echo "âœ… Model created successfully: $UNIQUE_MODEL_NAME"
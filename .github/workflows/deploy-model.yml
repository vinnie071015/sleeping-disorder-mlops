name: Deploy to EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: sleep-predictor
  CONTAINER_NAME: sleep_app_container

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    # --- é˜¶æ®µ 1: æ£€å‡ºä»£ç  ---
    - name: Checkout code
      uses: actions/checkout@v3

    # --- é˜¶æ®µ 2: é…ç½® AWS æƒé™ ---
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    # --- é˜¶æ®µ 3 (æ–°): æ¸…ç† ECR å¹¶æ¨é€æ–°é•œåƒ ---
    - name: Clean ECR & Build Push Image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ğŸ§¹ æ­£åœ¨æ¸…ç† ECR ä¸­çš„æ—§é•œåƒ..."
        # è·å–æ‰€æœ‰æ²¡æœ‰ tag çš„é•œåƒ (untagged) å¹¶åˆ é™¤
        aws ecr list-images --repository-name $ECR_REPOSITORY --filter tagStatus=UNTAGGED --query 'imageIds[*]' --output json | \
        jq -r '.[].imageDigest' | while read digest; do
          if [ "$digest" != "null" ]; then
            aws ecr batch-delete-image --repository-name $ECR_REPOSITORY --image-ids imageDigest=$digest || true
          fi
        done
        
        # (å¯é€‰) å¦‚æœæƒ³æ›´æ¿€è¿›ï¼Œåªä¿ç•™ latestï¼Œå¯ä»¥ç¼–å†™è„šæœ¬åˆ é™¤é™¤ latest å¤–çš„æ‰€æœ‰ tagã€‚
        # ä½†ä¸ºäº†å›æ»šå®‰å…¨ï¼Œé€šå¸¸å»ºè®®ä¿ç•™æœ€è¿‘å‡ ä¸ªã€‚ä¸Šé¢çš„é€»è¾‘ä¸»è¦æ¸…ç†æ‚¬ç©º(untagged)é•œåƒã€‚

        echo "ğŸ—ï¸ æ­£åœ¨æ„å»ºæ–°é•œåƒ..."
        docker build --platform linux/amd64 -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f docker/Dockerfile .
        
        echo "ğŸ·ï¸ æ‰“æ ‡ç­¾ä¸º latest..."
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        echo "ğŸš€ æ¨é€åˆ° ECR..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

    # --- é˜¶æ®µ 4: SSH ç™»å½• EC2 å¹¶éƒ¨ç½² ---
    - name: Deploy to EC2 via SSH
      uses: appleboy/ssh-action@v1.0.0
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        AWS_REGION: ${{ env.AWS_REGION }}
        CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        envs: ECR_REGISTRY,ECR_REPOSITORY,AWS_REGION,CONTAINER_NAME
        script: |
          echo "Connected to EC2!"
          
          # 1. ç™»å½• ECR
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
          
          # --- å…³é”®é€»è¾‘ï¼šå½»åº•æ¸…ç†ç¯å¢ƒ ---
          echo "ğŸ›‘ 1. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨..."
          docker stop $CONTAINER_NAME 2>/dev/null || true
          docker rm $CONTAINER_NAME 2>/dev/null || true
          
          echo "ğŸ§¹ 2. æ£€æŸ¥ 8000 ç«¯å£å ç”¨..."
          # æŸ¥æ‰¾å ç”¨ 8000 ç«¯å£çš„è¿›ç¨‹ PIDï¼Œå¦‚æœæœ‰åˆ™æ€æ­»
          PID=$(sudo lsof -t -i:8000)
          if [ -n "$PID" ]; then
            echo "å‘ç°ç«¯å£ 8000 è¢«è¿›ç¨‹ $PID å ç”¨ï¼Œæ­£åœ¨å¼ºåˆ¶ç»“æŸ..."
            sudo kill -9 $PID
          else
            echo "ç«¯å£ 8000 å¹²å‡€å¯ç”¨ã€‚"
          fi
          
          # --- éƒ¨ç½²æ–°ç¯å¢ƒ ---
          echo "â¬‡ï¸ 3. æ‹‰å–æœ€æ–°é•œåƒ..."
          docker pull $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "â–¶ï¸ 4. å¯åŠ¨æ–°å®¹å™¨..."
          docker run -d \
            --restart always \
            -p 8000:8000 \
            -p 8501:8501 \
            --name $CONTAINER_NAME \
            $ECR_REGISTRY/$ECR_REPOSITORY:latest
            
          echo "ğŸ—‘ï¸ 5. æ¸…ç† EC2 ä¸Šçš„æ—§é•œåƒ (dangling images)..."
          docker image prune -f
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"